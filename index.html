<!DOCTYPE html>
<html lang="ru">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Voice Rhythm Game</title>
<style>
    body { margin: 0; background: #111; color: #fff; font-family: sans-serif; }
    #menu { position: absolute; width: 100%; height: 100%; display: flex; align-items: center; justify-content: center; flex-direction: column; }
    .song-button { padding: 10px 20px; margin: 10px; cursor: pointer; background: #222; color: #fff; border: 1px solid #555; border-radius: 5px; }
    #gameCanvas { display: block; background: #000; }
    #hud { position: absolute; top: 10px; left: 10px; }
</style>
</head>
<body>

<div id="menu">
    <h1>Выберите песню</h1>
    <div id="songButtons"></div>
</div>

<canvas id="gameCanvas" width="800" height="400"></canvas>
<div id="hud">
    <div>Очки: <span id="score">0</span></div>
    <div>Комбо: <span id="combo">0</span></div>
    <div>Точность: <span id="accuracy">0%</span></div>
</div>

<audio id="audio"></audio>

<!-- Подключаем Tone.js MIDI через CDN -->
<script src="https://cdn.jsdelivr.net/npm/@tonejs/midi@2.0.27/build/Midi.js"></script>

<script>
// ---------- Глобальные переменные ----------
let audioContext;
let analyser;
let micStream;
let dataArray;
let currentPitch = null;
let audio = document.getElementById("audio");

// ---------- Авто-корреляция для определения частоты ----------
function autoCorrelate(buffer, sampleRate) {
    let SIZE = buffer.length;
    let rms = 0;
    for (let i = 0; i < SIZE; i++) rms += buffer[i] * buffer[i];
    rms = Math.sqrt(rms / SIZE);
    if (rms < 0.01) return null;

    let r = new Array(SIZE).fill(0);
    for (let lag = 0; lag < SIZE; lag++)
        for (let i = 0; i < SIZE - lag; i++)
            r[lag] += buffer[i] * buffer[i + lag];

    let d = 0;
    while (r[d] > r[d + 1]) d++;
    let maxval = -1, maxpos = -1;
    for (let i = d; i < SIZE; i++) {
        if (r[i] > maxval) {
            maxval = r[i];
            maxpos = i;
        }
    }
    let T0 = maxpos;
    if (T0 === 0) return null;
    return sampleRate / T0;
}

// ---------- Обновление текущей частоты ----------
function updatePitch() {
    if (!analyser) return null;
    analyser.getFloatTimeDomainData(dataArray);
    let freq = autoCorrelate(dataArray, audioContext.sampleRate);
    currentPitch = freq;
    return freq;
}

// ---------- Инициализация микрофона ----------
async function initMic() {
    if (!audioContext) audioContext = new (window.AudioContext || window.webkitAudioContext)();

    if (audioContext.state === "suspended") await audioContext.resume();

    try {
        micStream = await navigator.mediaDevices.getUserMedia({ audio: true });
        const micSource = audioContext.createMediaStreamSource(micStream);
        analyser = audioContext.createAnalyser();
        analyser.fftSize = 2048;
        micSource.connect(analyser);
        dataArray = new Float32Array(analyser.fftSize);
        console.log("Микрофон подключён");
    } catch (err) {
        alert("Ошибка микрофона: " + err);
        throw err;
    }
}

// ---------- Загрузка MIDI ----------
async function loadMidi(url) {
    const response = await fetch(url);
    const arrayBuffer = await response.arrayBuffer();
    const midi = new Midi(arrayBuffer);
    window.currentMidi = midi; // глобально для игры
}

// ---------- Загрузка субтитров (SRT) ----------
async function loadSRT(url) {
    const res = await fetch(url);
    const text = await res.text();
    window.currentLyrics = text; // глобально для игры
}

// ---------- Старт игры ----------
async function startGame(song) {
    document.getElementById("menu").style.display = "none";

    await initMic();

    audio.src = song.audio;
    await loadMidi(song.midi);
    await loadSRT(song.lyrics);

    audio.play();
    gameLoop();
}

// ---------- Пример gameLoop ----------
let canvas = document.getElementById("gameCanvas");
let ctx = canvas.getContext("2d");
let ball = { x: 100, y: 200, radius: 20 };

function mapFreqToY(freq) {
    if (!freq) return ball.y;
    let minFreq = 100, maxFreq = 1000;
    let minY = 50, maxY = canvas.height - 50;
    freq = Math.max(minFreq, Math.min(maxFreq, freq));
    return maxY - (freq - minFreq) / (maxFreq - minFreq) * (maxY - minY);
}

function gameLoop() {
    // Очистка
    ctx.clearRect(0, 0, canvas.width, canvas.height);

    // Обновление шарика
    updatePitch();
    ball.y = mapFreqToY(currentPitch);

    // Рисуем шарик
    ctx.beginPath();
    ctx.arc(ball.x, ball.y, ball.radius, 0, 2 * Math.PI);
    ctx.fillStyle = "#0f0";
    ctx.fill();

    requestAnimationFrame(gameLoop);
}

// ---------- Пример списка песен ----------
const songs = [
    { title: "Song 1", audio: "songs/song1.mp3", midi: "songs/song1.mid", lyrics: "songs/song1.srt" }
];

const songButtonsDiv = document.getElementById("songButtons");
songs.forEach(song => {
    let btn = document.createElement("div");
    btn.className = "song-button";
    btn.textContent = song.title;
    btn.onclick = () => startGame(song);
    songButtonsDiv.appendChild(btn);
});
</script>

</body>
</html>
